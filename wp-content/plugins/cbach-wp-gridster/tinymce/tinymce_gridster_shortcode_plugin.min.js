(function(){tinymce.create("tinymce.plugins.gridster_shortcode",{init:function(a,b){var c=this;c.url=b;c._createButtons();a.onBeforeSetContent.add(function(d,e){e.content=c._do_gridster_shortcode(e.content)});a.onExecCommand.add(function(d,e){if(e==="mceInsertContent"){tinyMCE.activeEditor.setContent(c._do_gridster_shortcode(tinyMCE.activeEditor.getContent()))}});a.onPostProcess.add(function(d,e){if(e.get){e.content=c._get_gridster_shortcode(e.content)}});a.addCommand("ajax_gridster_shortcode_update_modal",function(e,d){a.windowManager.open({file:ajaxurl+"?action=ajax_gridster_shortcode_update_modal&nonce="+a.getLang("gridster_shortcode.AjaxNonce")+"&selected="+d,width:300,height:240,title:a.getLang("gridster_shortcode.popupTitle"),inline:1},{plugin_url:b})});a.addCommand("gridster_edit_current_gridster",function(){var d=tinymce.activeEditor,h=d.selection.getNode();if(h.nodeName=="IMG"&&d.dom.hasClass(h,"gridsterShortcodeGUI")){var e=d.plugins.gridster_shortcode._get_gridster_id(h);var g=ajaxurl.split("admin-ajax.php");var i=g[0];var f="post.php?post="+e+"&action=edit";window.top.location.href=i+f}});a.addButton("gridster_shortcode",{title:a.getLang("gridster_shortcode.buttonTitle"),cmd:"ajax_gridster_shortcode_update_modal"});a.onMouseDown.add(function(d,f){if(f.target.nodeName=="IMG"&&d.dom.hasClass(f.target,"gridsterShortcodeGUI")){d.plugins.gridster_shortcode._hideButtons();d.plugins.wordpress._showButtons(f.target,"gridster_sr_btns")}});a.onInit.add(function(d){tinymce.dom.Event.add(d.getWin(),"scroll",function(f){d.plugins.gridster_shortcode._hideButtons()});tinymce.dom.Event.add(d.getBody(),"dragstart",function(f){d.plugins.gridster_shortcode._hideButtons()})});a.onBeforeExecCommand.add(function(d,f,e,g){d.plugins.gridster_shortcode._hideButtons()});a.onSaveContent.add(function(d,e){d.plugins.gridster_shortcode._hideButtons()});a.onMouseDown.add(function(d,f){if(f.target.nodeName!="IMG"){d.plugins.gridster_shortcode._hideButtons()}});a.onKeyDown.add(function(d,f){if(f.which==tinymce.VK.DELETE||f.which==tinymce.VK.BACKSPACE){d.plugins.gridster_shortcode._hideButtons()}})},_do_gridster_shortcode:function(b){var a=this;return b.replace(/\[gridster([^\]]*)\]/g,function(d,c){return'<img src="'+a.url+'/img/t.gif" class="gridsterShortcodeGUI mceItem" title="gridster'+tinymce.DOM.encode(c)+'" />'})},_get_gridster_shortcode:function(b){function a(c,d){d=new RegExp(d+'="([^"]+)"',"g").exec(c);return d?tinymce.DOM.decode(d[1]):""}return b.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(e,d){var c=a(d,"class");if(c.indexOf("gridsterShortcodeGUI")!=-1){return"<p>["+tinymce.trim(a(d,"title"))+"]</p>"}return e})},_get_gridster_id:function(d){function c(g,h){h=new RegExp(h+"=&quot;([0-9]+)&quot;").exec(g);return h?tinymce.DOM.decode(h[1]):""}var f=d.cloneNode(true);var b=document.createElement("div");b.appendChild(f);var e=b.innerHTML;var a=c(e,"id");return a},_createButtons:function(){var b=this,a=tinymce.activeEditor,d=tinymce.DOM,e,c,f;if(d.get("gridster_sr_btns")){return}f=(window.devicePixelRatio&&window.devicePixelRatio>1)||(window.matchMedia&&window.matchMedia("(min-resolution:130dpi)").matches);d.add(document.body,"div",{id:"gridster_sr_btns",style:"display:none;"});changeButton=d.add("gridster_sr_btns","img",{src:f?b.url+"/img/change-2x.png":b.url+"/img/change.png",id:"gridster_changeShortcode",width:"24",height:"24",title:a.getLang("gridster_shortcode.changeButton")});tinymce.dom.Event.add(changeButton,"mousedown",function(j){var g=tinymce.activeEditor,i=g.selection.getNode();if(i.nodeName=="IMG"&&g.dom.hasClass(i,"gridsterShortcodeGUI")){var h=g.plugins.gridster_shortcode._get_gridster_id(i);g.execCommand("ajax_gridster_shortcode_update_modal",false,h);g.plugins.gridster_shortcode._hideButtons()}});e=d.add("gridster_sr_btns","img",{src:f?b.url+"/img/edit-2x.png":b.url+"/img/edit.png",id:"gridster_editShortcode",width:"24",height:"24",title:a.getLang("gridster_shortcode.editButton")});tinymce.dom.Event.add(e,"mousedown",function(h){var g=tinymce.activeEditor;g.execCommand("gridster_edit_current_gridster");g.plugins.gridster_shortcode._hideButtons()});c=d.add("gridster_sr_btns","img",{src:f?b.url+"/img/delete-2x.png":b.url+"/img/delete.png",id:"gridster_delShortcode",width:"24",height:"24",title:a.getLang("gridster_shortcode.dellButton")});tinymce.dom.Event.add(c,"mousedown",function(i){var g=tinymce.activeEditor,h=g.selection.getNode();if(h.nodeName=="IMG"&&g.dom.hasClass(h,"gridsterShortcodeGUI")){g.dom.remove(h);g.execCommand("mceRepaint");g.dom.events.cancel(i)}g.plugins.gridster_shortcode._hideButtons()})},_hideButtons:function(){var a=tinymce.DOM;a.hide(a.select("#gridster_sr_btns"))},getInfo:function(){return{longname:"Gridster shortcode replace with user-friendly GUI",author:"Carsten Bach",authorurl:"http://carsten-bach.de",infourl:"https://github.com/carstingaxion/cbach-wp-gridster",version:"1.0"}}});tinymce.PluginManager.add("gridster_shortcode",tinymce.plugins.gridster_shortcode)})();